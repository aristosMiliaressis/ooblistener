#!/bin/bash

if [ "$EUID" -ne 0 ]
then
    echo "Please run as root"
    exit 1
fi

. /etc/profile

CERT_BASE_PATH="/root/.local/share/certmagic/certificates/acme-v02.api.letsencrypt.org-directory"
ROOT_CERT_FILEPATH="$CERT_BASE_PATH/$DOMAIN/$DOMAIN.crt"
ROOT_KEY_FILEPATH="$CERT_BASE_PATH/$DOMAIN/$DOMAIN.key"
WILDCARD_CERT_FILEPATH="$CERT_BASE_PATH/wildcard_.$DOMAIN/wildcard_.$DOMAIN.crt"
WILDCARD_KEY_FILEPATH="$CERT_BASE_PATH/wildcard_.$DOMAIN/wildcard_.$DOMAIN.key"

cat >/etc/apache2/sites-available/${DOMAIN}.conf <<EOF
<VirtualHost *:80>
    ServerName ${DOMAIN}
    ServerAlias *.${DOMAIN}

    WSGIDaemonProcess exploit_srv user=www-data group=www-data threads=5
        WSGIProcessGroup exploit_srv
        WSGIScriptAlias / /var/www/exploit_srv/api.wsgi

        <Directory /var/www/exploit_srv>
            WSGIProcessGroup exploit_srv
            Require all granted
        </Directory>
</VirtualHost>

<VirtualHost *:443>
        ServerName ${DOMAIN}

        SSLCertificateFile "${ROOT_CERT_FILEPATH}"
        SSLCertificateKeyFile "${ROOT_KEY_FILEPATH}"

        WSGIDaemonProcess exploit_srv-https user=www-data group=www-data threads=5
        WSGIProcessGroup exploit_srv-https
        WSGIScriptAlias / /var/www/exploit_srv/api.wsgi

        <Directory /var/www/exploit_srv>
            WSGIProcessGroup exploit_srv-https
            Require all granted
        </Directory>
</VirtualHost>

<VirtualHost *:443>
        ServerAlias *.${DOMAIN}

        SSLCertificateFile "${WILDCARD_CERT_FILEPATH}"
        SSLCertificateKeyFile "${WILDCARD_KEY_FILEPATH}"

        WSGIDaemonProcess exploit_srv-wildcard user=www-data group=www-data threads=5
        WSGIProcessGroup exploit_srv-wildcard
        WSGIScriptAlias / /var/www/exploit_srv/api.wsgi

        <Directory /var/www/exploit_srv>
            WSGIProcessGroup exploit_srv-wildcard
            Require all granted
        </Directory>
</VirtualHost>
EOF

a2enmod ssl
a2enmod rewrite
a2enmod wsgi

a2ensite ${DOMAIN}.conf
a2dissite 000-default.conf

systemctl enable apache2
systemctl restart apache2
